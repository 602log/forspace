<?xml version="1.0" encoding="UTF-8"?>

<!DOCTYPE mapper
    PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
    "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
    
<mapper namespace="kr.co.forspace.mapper.BookingMapper">

	<resultMap type="kr.co.forspace.booking.BookingDTO" id="bookingMap">
		<id column="BO_NO" property="boNo"/>
		<result column="SC_NO" property="scNo"/>
		<result column="ME_EMAIL" property="meEmail"/>
		<result column="RO_NO" property="roNo"/>
		<result column="BO_TIME" property="boTime"/>
		<result column="BO_DATE" property="boDate"/>
		<collection property="roomList" resultMap="roomListMap"></collection>
	</resultMap>
	
	<resultMap type="kr.co.forspace.booking.BookingDTO" id="roomListMap">
		<result column="RO_NO" property="roNo"/>
		<result column="SC_NO" property="scNo"/>
		<result column="RO_NAME" property="roName"/>
		<result column="RO_FLOOR" property="roFloor"/>
		<result column="RO_MAX" property="roMax"/>
		<result column="RO_START" property="roStart"/>
		<result column="RO_CLOSE" property="roClose"/>
		<result column="RO_LIMIT" property="roLimit"/>
		<result column="RO_REGDATE" property="roRegdate"/>
		<result column="RO_LIKECNT" property="roLikecnt"/>
	</resultMap>

	<select id="mybookingList" resultType="kr.co.forspace.booking.BookingDTO" parameterType="String">
	<![CDATA[
		SELECT R.RO_NAME as roName, A.BO_NO as boNo, A.BO_DATE as boDate, A.BO_TIME as boTime
		FROM ROOM R, 
					(SELECT bo_no, ro_no, bo_date, bo_time
					FROM BOOKING
					WHERE bo_no IN 
									(SELECT bo_no FROM 
										(SELECT ro_no, min(bo_no) as bo_no
										 FROM booking
										 WHERE me_email = #{meEmail}
										 GROUP BY ro_no)
									)
					)A
		WHERE R.RO_NO = A.RO_NO
	]]>
	</select>
	
<!-- 	<select id="mybookingList" resultType="kr.co.forspace.booking.BookingDTO" parameterType="String">
		SELECT ME_EMAIL as meEmail, RO_NO as roNo, BO_TIME as boTime, BO_DATE as bo_date
		FROM BOOKING
		WHERE ME_EMAIL = #{meEmail}
		GROUP BY RO_NO
	</select> -->
	
	<select id="findBookingTime" resultType="int" parameterType="kr.co.forspace.booking.BookingDTO">
	<![CDATA[	
		SELECT COUNT(BO_NO)
		FROM BOOKING
		WHERE RO_NO = #{roNo} AND TO_CHAR(BO_DATE, 'yyyy/MM/dd') = #{boDateStr} AND BO_TIME = #{boTimeStr}
	]]>
	</select>
	
	<select id="findMyBook" resultType="int" parameterType="kr.co.forspace.booking.BookingDTO">
	<![CDATA[	
		SELECT COUNT(BO_NO)
		FROM BOOKING
		WHERE ME_EMAIL = #{meEmail} AND RO_NO = #{roNo} AND TO_CHAR(BO_DATE, 'yyyy/MM/dd') = #{boDateStr}
	]]>
	</select>
	
	<select id="checkBook" resultType="kr.co.forspace.booking.BookingDTO" parameterType="kr.co.forspace.booking.BookingDTO">
	<![CDATA[
		SELECT BO_NO AS boNo, SC_NO AS scNo, ME_EMAIL AS meEmail, RO_NO AS roNo, BO_TIME AS boTime, BO_DATE AS boDate
		FROM BOOKING
		WHERE RO_NO = #{roNo} AND TO_CHAR(BO_DATE, 'yyyy/MM/dd') = #{boDateStr}
	]]>
	</select>
	
	<insert id="insertBook">
		<![CDATA[
		INSERT INTO BOOKING (BO_NO, SC_NO, ME_EMAIL, RO_NO, BO_TIME)
		VALUES(SEQ_BO.nextval, #{scNo}, #{meEmail}, #{roNo}, #{boTime})
		]]>
	</insert>


</mapper>